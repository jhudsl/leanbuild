---
title: "getting-started"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{getting-started}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(leanbuild)
```


# Intro to leanbuild

`leanbuild` converts a [Bookdown repository](https://github.com/jtr13/bookdown-template) into a [Leanpub-ready](https://leanpub.com/) set of files.
The output rendered files from this package can be published using the [Github writing mode on Leanpub](https://leanpub.com/lfm/read#leanpub-auto-switching-writing-modes).

If you aren't familiar with `Bookdown` you may want with [their tutorials](https://bookdown.org/yihui/bookdown/). 

## Required files:

Before you are ready to run `leanbuild`, you will need the following files (which are standard in a `Bookdown` repository):  
- a `_bookdown.yml` file which lists the `.Rmd` files that are to be rendered in a `rmd: ` category (see [example file](https://github.com/jhudsl/DaSL_Course_Template_Leanpub/blob/main/_bookdown.yml)).
- `.Rmd` files which contain the chapter content (including your `index.Rmd` file which `Bookdown` has).
- an `images` directory that contains any images that are referenced in the chapters.
- `.bib` file(s) to complete any citation renders (see [example file](https://github.com/jhudsl/DaSL_Course_Template_Leanpub/blob/main/book.bib)).

_Optionally:_
- [a `Book.txt` file](https://leanpub.com/lfm/read#leanpub-auto-booktxt-sampletxt-and-manuscript-files) which lists the order of the chapters/quiz files (this can be autogenerated with `leanbuild`) (see [example file](https://github.com/jhudsl/DaSL_Course_Template_Leanpub/blob/main/Book.txt)).
- a directory containing quizzes in the form of `.md` files which have been written using the [Markua formatting specifications](https://leanpub.com/markua/read#leanpub-auto-quizzes-and-exercises) (see [example folder](https://github.com/jhudsl/DaSL_Course_Template_Leanpub/tree/main/quizzes)).

Here's an example of what the Bookdown file set up (which leanbuild will look for) might be set up like:
```
A_Bookdown_Repo
├── _bookdown.yml
├── index.Rmd
├── 01-chapter_one.Rmd
├── docs
│   └── ...
├── references.bib
├── quizzes
│   ├── quiz_1.md
│   └── ...
├── resources/images
│   ├── some-figures.png
│   └── ...
└── Book.txt
```

## Set up example data

If you'd like to use our example repository you can fork it on Github and clone it to your own computer
[Follow these instructions to fork](https://docs.github.com/en/get-started/quickstart/fork-a-repo#forking-a-repository) and then you can clone it using a command line.

But for the purposes of this example we will download a zip file of the files we need and set those up using this function: 

```{r}
# Run this to get the files we need
example_repo_setup()
```

Each of your Rmds needs to have a chunk of code with this at the beginning of the file:
`leanbuild::set_knitr_image_path()`

This will ensure that the images are stored in the correct place and will be rendered correctly both in `Bookdown` and in Leanpub.

## Installing leanbuild:

You can install `leanbuild` from GitHub with:

You will need to use the remotes package (and will need to install it if you don't have it).

```{r}
if (!("remotes" %in% installed.packages())) {
  install.packages("remotes")
}
if (!("leanbuild" %in% installed.packages())) {
  remotes::install_github("jhudsl/leanbuild")
}
```

## Running leanbuild

The `leanbuild` package converts your files using this main function (which we won't run just yet).

```
leanbuild::bookdown_to_leanpub()
```

By default, `leanbuild` will re-run a `bookdown::render_book("index.Rmd")` rendering of your chapters first before converting the files to the Leanpub ready format.
It will only process the `Rmd` files that are listed in the `_bookdown.yml` file. 
However, if you wish to skip this step, you can set `render = FALSE` when running the `leanbuild::bookdown_to_leanpub()` function.

## About the output files

Leanpub's Github writing mode will look for a directory called `manuscript` to publish from.
You should not edit the files in `manuscript/` by hand since a re-run of `leanbuild` will cause your changes to be overwritten.

## About the Book.txt file:

Leanpub requires a [`Book.txt`](https://leanpub.com/lfm/read#leanpub-auto-booktxt-sampletxt-and-manuscript-files) file to know what order the chapters/quizzes should be published.

By default, your `Book.txt` file will _not_ be autogenerated but `leanbuild` will look in your given directory for an existing `Book.txt` file which it will copy over to the output directory.

You can create a `Book.txt` file manually, or if your quizzes and chapters are numbered, `leanbuild` can create the `Book.txt` file based on the numbers going from low to high and quizzes following chapters of the same number.
(e.g. `quiz_03.md` will be placed after `03-some_chapter_file.Rmd`).

To have `leanbuild` attempt to autogenerate this file with the main function you can set `make_book_txt` to `TRUE`. 
If no `Book.txt` file is found and `make_book_txt` is set to `FALSE` (this is the default setting), `leanbuild` will fail.

So to run the main function and also have it make a `Book.txt` file for us, we can run the following: 

```{r}
leanbuild::bookdown_to_leanpub(make_book_txt = TRUE)
```

Alternatively we could run `bookdown_to_book_txt()` function on its own:

```{r}
leanbuild::bookdown_to_book_txt()
```

Also note that any `index.Rmd` will always be placed first and any `about.Rmd` file will be placed last.

We can take a peek at what the autogenerated file looks like. 
By default the `Book.txt` file is saved to the `manuscript` directory along with all the other Leanpub-ready files. 

```{r}
readLines(file.path("manuscript", "Book.txt"))
```

## Setting up quizzes:

By default, leanbuild will look for a folder called `quizzes/` to find your quiz `.md` files.
If your quizzes are located somewhere else, you will need to use the `quiz_dir` argument to specify that:

```
leanbuild::bookdown_to_leanpub(quiz_dir = "some_other_directory")
```

Leanpub can be very particular about the formatting of the quizzes, so there are funtions to help you check the formatting of your quiz. 

In the main argument, you can set `run_quiz_checks` to `TRUE` (the default is `FALSE`).

```
leanbuild::bookdown_to_leanpub(make_book_txt = TRUE)
```

But the quiz checks can also be run separately using the `check_quizzes()` function. 
It will again assume you have a directory called `quizzes` unless you specify otherwise:

We can take a look at how `check_quizzes()` runs using a quiz examples: one that passes the checks and one that fails.

```{r}
# Set up an good example quiz
good_quiz_path <- good_quiz_path()

dest_quiz_path <- file.path("quizzes", basename(good_quiz_path))
                       
file.copy(from = good_quiz_path, 
          to = dest_quiz_path)
```

Run `check_quizzes()` to check all quizzes in the directory.

```{r}
check_quizzes(quiz_dir = "quizzes")
```
We can take a look at what a typical quiz format looks like: 

```{r}
quiz_lines <- readLines(dest_quiz_path)
quiz_lines
```

Good quiz example: 

```{r}
good_quiz_path()
```

## Adding footer text:

If there is text you would like added to the end of each chapter (like a link to a feedback survey for example), you can supply a character string to the `footer_text`argument in the main `leanbuild::bookdown_to_leanpub()` function.

```{r}
# Set up a character string
survey_link <- "Please provide any feedback you have in [this survey](www.some_link.org)"

# Supply the footer text in the main function
leanbuild::bookdown_to_leanpub(footer_text = survey_link)
```


### Wrapping up 

If you don't want those example files hanging around, we can run this function to cleanup and remove them:

```{r, echo = FALSE}
leanbuild::example_repo_cleanup()
```

Lastly, we will print out the session info.

```{r}
devtools::session_info()
```
